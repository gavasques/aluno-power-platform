import { useState, useCallback, useEffect } from 'react';
import { useToast } from '@/hooks/use-toast';
import { useAuth } from '@/contexts/AuthContext';
import type { Agent } from '@shared/schema';
import { BULLET_POINTS_CONFIG } from '@/lib/bulletPointsConfig';

interface UseBulletPointsGeneratorProps {
  agent?: Agent;
}

interface GenerationState {
  productName: string;
  brand: string;
  textInput: string;
  targetAudience: string;
  keywords: string;
  uniqueDifferential: string;
  materials: string;
  warranty: string;
  bulletPointsOutput: string;
  isGenerating: boolean;
  generatedBulletPoints: string;
  showReplaceDialog: boolean;
}

const BULLET_POINTS_PROMPT = `Gerar 8 bullet points convincentes que destaquem os benef√≠cios do produto e levem o cliente a agir agora.

## üìù Formato e Estilo dos Bullet Points

**Estrutura:** BENEF√çCIO PRINCIPAL EM MAI√öSCULAS ‚Äì seguido de h√≠fen "-" e ent√£o uma descri√ß√£o com caracter√≠sticas de suporte que comprovem esse benef√≠cio.

**Tom:** Comercial, extremamente persuasivo e envolvente, focado em despertar urg√™ncia e desejo de compra agora. Fale diretamente com o cliente usando "voc√™"/"seu".

**Quantidade e Tamanho:** Escreva 8 bullet points, cada um com entre 150 e 200 caracteres (contando espa√ßos). Nunca menos de 150 ou mais de 200 caracteres por bullet.

**Call to Action:** O 3¬∫ bullet point deve terminar com "ADICIONAR AO CARRINHO" (em mai√∫sculas). Os demais n√£o precisam incluir este texto.

**Formata√ß√£o:** Forne√ßa a resposta final em Markdown, com os bullet points listados claramente (pode numerar de 1 a 8 ou usar "-" para cada bullet). Separe a parte de an√°lise pr√©via e os bullet points por se√ß√µes, conforme Etapas definidas abaixo.

## üì¶ Conte√∫do e Estrutura dos 8 Bullet Points

Cada bullet point ter√° um foco espec√≠fico, conforme abaixo:

1. **P√öBLICO-ALVO + PROPOSTA √öNICA DE VALOR:** Quem √© o cliente ideal e qual o diferencial √∫nico do produto. Estabele√ßa autoridade e confian√ßa, mostrando como este produto √© superior aos concorrentes e feito sob medida para o cliente. Tom: Transformacional (prometa uma mudan√ßa significativa, n√£o apenas melhoria incremental).

2. **BENEF√çCIO EMOCIONAL PRINCIPAL:** Destaque o principal benef√≠cio emocional que o cliente ter√°. Foque no resultado real e sensorial que ele vai sentir ao usar o produto e conecte brevemente como alguma caracter√≠stica do produto proporciona esse resultado. Tom: Experiencial, evocando sentimentos positivos.

3. **CARACTER√çSTICAS T√âCNICAS + BENEF√çCIOS (com CTA):** Apresente as principais caracter√≠sticas t√©cnicas ou funcionais do produto e ligue cada recurso a um benef√≠cio concreto. Se poss√≠vel, responda a alguma d√∫vida frequente ou obje√ß√£o do cliente atrav√©s dessas caracter√≠sticas. Termine este bullet point com uma chamada para a√ß√£o "ADICIONAR AO CARRINHO". Tom: Educativo e persuasivo.

4. **FACILIDADE DE USO:** Explique como o produto √© f√°cil de usar ou manter. Destaque a conveni√™ncia e praticidade, removendo medos ou barreiras de uso. Tom: Tranquilizador e encorajador.

5. **REDU√á√ÉO DE RISCO + GARANTIAS:** Reforce elementos que passem seguran√ßa ao cliente. Inclua garantias, certifica√ß√µes, qualidade premium, origem confi√°vel ou suporte que venha com o produto. Conecte tamb√©m com valores do cliente se relevante. Tom: Confi√°vel e seguro.

6. **TRANSFORMA√á√ÉO / RESULTADO FINAL:** Pinte um quadro da transforma√ß√£o completa que o produto proporciona. Use contraste de antes e depois para mostrar o impacto na vida do cliente ap√≥s o uso. Crie um senso de urg√™ncia para aproveitar essa transforma√ß√£o agora. Tom: Inspiracional e empolgante.

7. **EXCLUSIVIDADE + INOVA√á√ÉO:** Destaque o que torna o produto √∫nico ou exclusivo. Isso pode ser uma tecnologia avan√ßada, design inovador, edi√ß√£o limitada ou parceria exclusiva. Invoque a sensa√ß√£o de que este produto √© especial e dif√≠cil de encontrar em outro lugar. Tom: Urgente e exclusivo.

8. **CALL TO ACTION FINAL (Resumo dos Benef√≠cios):** Uma chamada final irresist√≠vel √† a√ß√£o. Fa√ßa uma s√≠ntese poderosa dos principais benef√≠cios j√° mencionados, lembrando o cliente do quanto ele tem a ganhar. Termine convidando-o a agir imediatamente. Tom: Extremamente urgente e convincente, irresist√≠vel.

## üß† T√©cnicas de Copywriting Obrigat√≥rias

Incorpore as seguintes estrat√©gias psicol√≥gicas:

- **Agita√ß√£o da Dor:** Mencione brevemente o problema ou dor que o produto resolve
- **Ponte Benef√≠cio-Caracter√≠stica:** Sempre que citar uma caracter√≠stica t√©cnica, imediatamente conecte-a a como isso beneficia o cliente na pr√°tica
- **Prova Social/Autoridade:** Reforce a credibilidade com prova social ou autoridade relacionada
- **Urg√™ncia:** Utilize palavras que criem senso de urg√™ncia temporal, incentivando o cliente a n√£o adiar a compra
- **Propriedade Mental:** Leve o cliente a se imaginar usando o produto e desfrutando dos benef√≠cios
- **Transforma√ß√£o:** Reforce a ideia de que o produto traz uma mudan√ßa transformadora na vida do cliente

## üí• Palavras de Poder (Power Words)

Inclua, quando adequado: Finalmente, Revolucion√°rio, Exclusivo, Comprovado, Superior, Imediato, Instant√¢neo, Transforme, Experimente, Descubra, Garantido, Clinicamente Testado, Premium, Profissional, √önico, Avan√ßado, Inovador, Eficaz, Poderoso.

## üö´ Restri√ß√µes (O que N√ÉO fazer)

‚ùå Falar em 1¬™ pessoa plural: N√£o use "n√≥s" ou "nosso(a)". Aborde sempre o cliente diretamente como "voc√™"
‚ùå Men√ß√µes de pre√ßo, promo√ß√£o ou envio: N√£o mencione valores, descontos, frete, parcelamento, cupons, ou pol√≠ticas de devolu√ß√£o
‚ùå Press√£o de estoque expl√≠cita: N√£o use frases como "somente X unidades" ou "estoque limitado"
‚ùå Listar cores dispon√≠veis: N√£o fa√ßa listagens do tipo "Dispon√≠vel nas cores X, Y..."
‚ùå Jarg√µes t√©cnicos sem explica√ß√£o: Se precisar citar termos t√©cnicos, explique o benef√≠cio que eles trazem
‚ùå Linguagem gen√©rica ou promessas vagas: Evite termos como "alta qualidade" sem contexto
‚ùå Fugir do tema do produto: N√£o inclua informa√ß√µes que n√£o estejam relacionadas ao produto
‚ùå Inventar funcionalidades/benef√≠cios n√£o fornecidos: Use apenas informa√ß√µes fornecidas sobre o produto

## üìä Etapa 1: An√°lise Pr√©via do Produto

Antes de redigir os bullet points, analise as informa√ß√µes do produto e identifique:

- **Diferencial √önico:** O que torna este produto melhor ou diferente dos concorrentes?
- **Materiais:** Do que o produto √© feito? Esses materiais trazem alguma vantagem?
- **Cores/Design:** Qual √© o design ou as cores do produto e por que isso importa para o cliente?
- **Embalagem:** Como √© a embalagem e qual o valor agregado dela?
- **Detalhes Adicionais:** Informa√ß√µes extras relevantes
- **Top 7 Benef√≠cios para o Cliente:** Liste os 7 benef√≠cios mais fortes e desejados que esse produto oferece

## üöÄ Etapa 2: Cria√ß√£o dos Bullet Points de Alta Convers√£o

Com base na an√°lise acima, redija os 8 bullet points seguindo estritamente o formato e conte√∫do especificado:

- Iniciar cada bullet com o benef√≠cio principal em mai√∫sculas, seguido de "‚Äì" e detalhes persuasivos
- Incorporar palavras de poder e t√©cnicas psicol√≥gicas conforme adequado
- Manter o limite de caracteres (150 a 200) em cada bullet, sem exceder
- Revisar o tom para garantir que est√° fortemente persuasivo, focado no cliente
- Especial aten√ß√£o ao 3¬∫ bullet: inclua no final a frase "ADICIONAR AO CARRINHO"
- Bullet 8 deve concluir amarrando os principais benef√≠cios e convidando √† a√ß√£o imediata

**IMPORTANTE:** Execute primeiro a Etapa 1 (an√°lise) e em seguida a Etapa 2 (bullet points).

Agora, utilizando as informa√ß√µes fornecidas sobre o produto abaixo, execute a Etapa 1 (an√°lise) e em seguida a Etapa 2 (bullet points):

{{PRODUCT_INFO}}`;

export const useBulletPointsGenerator = ({ agent }: UseBulletPointsGeneratorProps) => {
  const [state, setState] = useState<GenerationState>({
    productName: '',
    brand: '',
    textInput: '',
    targetAudience: '',
    keywords: '',
    uniqueDifferential: '',
    materials: '',
    warranty: '',
    bulletPointsOutput: '',
    isGenerating: false,
    generatedBulletPoints: '',
    showReplaceDialog: false,
  });

  const [agentConfig, setAgentConfig] = useState({
    provider: 'openai',
    model: 'gpt-4o-mini',
    temperature: 0.7,
    maxTokens: 2000
  });

  const { toast } = useToast();
  const { user } = useAuth();

  const updateState = useCallback((updates: Partial<GenerationState>) => {
    setState(prev => ({ ...prev, ...updates }));
  }, []);

  // Atualizar configura√ß√£o automaticamente quando o agente mudar
  useEffect(() => {
    if (agent) {
      const newConfig = {
        provider: agent.provider || 'openai',
        model: agent.model || 'gpt-4o-mini',
        temperature: typeof agent.temperature === 'string' ? parseFloat(agent.temperature) : agent.temperature || 0.7,
        maxTokens: agent.maxTokens || 2000
      };
      console.log('üîß [BULLET_POINTS] Auto-updating agent config:', newConfig);
      setAgentConfig(newConfig);
    }
  }, [agent]);

  const updateAgentConfig = useCallback(() => {
    if (agent) {
      const newConfig = {
        provider: agent.provider || 'openai',
        model: agent.model || 'gpt-4o-mini',
        temperature: typeof agent.temperature === 'string' ? parseFloat(agent.temperature) : agent.temperature || 0.7,
        maxTokens: agent.maxTokens || 2000
      };
      console.log('üîß [BULLET_POINTS] Manual update agent config:', newConfig);
      setAgentConfig(newConfig);
    }
  }, [agent]);

  const generateWithAI = useCallback(async () => {
    if (!state.productName.trim() || !state.textInput.trim()) {
      toast({
        variant: "destructive",
        title: "‚ùå Campos obrigat√≥rios",
        description: "Preencha o nome do produto e as informa√ß√µes detalhadas.",
      });
      return;
    }

    updateState({ isGenerating: true });

    try {
      // SEMPRE buscar as configura√ß√µes mais recentes do agente antes de gerar
      const agentResponse = await fetch('/api/agents/bullet-points-generator', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      
      if (!agentResponse.ok) {
        throw new Error('Erro ao buscar configura√ß√µes do agente');
      }
      
      const agentData = await agentResponse.json();
      const currentConfig = {
        provider: agentData.provider || 'openai',
        model: agentData.model || 'gpt-4o-mini',
        temperature: typeof agentData.temperature === 'string' ? parseFloat(agentData.temperature) : agentData.temperature || 0.7,
        maxTokens: agentData.maxTokens || 2000
      };

      console.log('üöÄ [BULLET_POINTS] Starting generation with FRESH config:', currentConfig);
      setAgentConfig(currentConfig); // Atualizar o estado local tamb√©m

      const startTime = Date.now();

      const productInfo = `
NOME DO PRODUTO: ${state.productName}
${state.brand ? `MARCA: ${state.brand}` : ''}
${state.targetAudience ? `P√öBLICO-ALVO: ${state.targetAudience}` : ''}
${state.keywords ? `PALAVRAS-CHAVE: ${state.keywords}` : ''}
${state.uniqueDifferential ? `DIFERENCIAL √öNICO: ${state.uniqueDifferential}` : ''}
${state.materials ? `MATERIAIS: ${state.materials}` : ''}
${state.warranty ? `GARANTIA: ${state.warranty}` : ''}

INFORMA√á√ïES DETALHADAS DO PRODUTO:
${state.textInput}
      `.trim();

      const prompt = BULLET_POINTS_PROMPT.replace('{{PRODUCT_INFO}}', productInfo);

      const response = await fetch('/api/ai-providers/test', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
          provider: currentConfig.provider,
          model: currentConfig.model,
          prompt: prompt,
          maxTokens: currentConfig.maxTokens,
          temperature: currentConfig.temperature
        })
      });

      if (!response.ok) {
        throw new Error('Erro na API da IA');
      }

      const data = await response.json();
      if (!data.success) {
        throw new Error(data.error || 'Erro na gera√ß√£o de bullet points');
      }

      const endTime = Date.now();
      const duration = endTime - startTime;
      const responseText = data.response;

      // Salvar log da gera√ß√£o (somente se usu√°rio estiver logado)
      if (user && user.id) {
        await fetch('/api/ai-generation-logs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({
            userId: user.id,
            provider: currentConfig.provider,
            model: currentConfig.model,
            prompt: prompt,
            response: responseText,
            promptCharacters: prompt.length,
            responseCharacters: responseText.length,
            inputTokens: data.responseReceived ? JSON.parse(data.responseReceived).usage?.inputTokens || 0 : 0,
            outputTokens: data.responseReceived ? JSON.parse(data.responseReceived).usage?.outputTokens || 0 : 0,
            totalTokens: data.responseReceived ? JSON.parse(data.responseReceived).usage?.totalTokens || 0 : 0,
            cost: data.cost || 0,
            duration: duration,
            feature: 'bullet-points-generator'
          })
        });
      }

      if (state.bulletPointsOutput && state.bulletPointsOutput.trim()) {
        updateState({ 
          generatedBulletPoints: responseText,
          showReplaceDialog: true 
        });
      } else {
        updateState({ bulletPointsOutput: responseText });
        toast({
          title: "‚úì Bullet Points Gerados!",
          description: "Bullet points criados com sucesso usando IA",
        });
      }
    } catch (error) {
      toast({
        variant: "destructive",
        title: "‚ùå Erro ao gerar bullet points",
        description: error instanceof Error ? error.message : "Erro desconhecido",
      });
    } finally {
      updateState({ isGenerating: false });
    }
  }, [state.productName, state.textInput, state.brand, state.targetAudience, state.keywords, state.bulletPointsOutput, user, agentConfig, toast, updateState]);

  const copyBulletPoints = useCallback(async () => {
    try {
      await navigator.clipboard.writeText(state.bulletPointsOutput);
      toast({
        title: "‚úì Copiado!",
        description: "Bullet points copiados para a √°rea de transfer√™ncia",
      });
    } catch (err) {
      toast({
        variant: "destructive",
        title: "‚ùå Erro",
        description: "Erro ao copiar bullet points",
      });
    }
  }, [state.bulletPointsOutput, toast]);

  const handleReplace = useCallback(() => {
    updateState({
      bulletPointsOutput: state.generatedBulletPoints,
      showReplaceDialog: false,
      generatedBulletPoints: ''
    });
    toast({
      title: "‚úì Bullet Points Substitu√≠dos!",
      description: "Novos bullet points aplicados com sucesso",
    });
  }, [state.generatedBulletPoints, toast, updateState]);

  const handleKeepBoth = useCallback(() => {
    const separator = '\n\n--- NOVA VERS√ÉO ---\n\n';
    updateState({
      bulletPointsOutput: state.bulletPointsOutput + separator + state.generatedBulletPoints,
      showReplaceDialog: false,
      generatedBulletPoints: ''
    });
    toast({
      title: "‚úì Vers√µes Combinadas!",
      description: "Ambas as vers√µes foram mantidas",
    });
  }, [state.bulletPointsOutput, state.generatedBulletPoints, toast, updateState]);

  const handleClearAll = useCallback(() => {
    updateState({
      productName: '',
      brand: '',
      textInput: '',
      targetAudience: '',
      keywords: '',
      bulletPointsOutput: '',
      generatedBulletPoints: '',
      showReplaceDialog: false
    });
  }, [updateState]);

  return {
    state,
    agentConfig,
    updateState,
    updateAgentConfig,
    generateWithAI,
    copyBulletPoints,
    handleReplace,
    handleKeepBoth,
    handleClearAll
  };
};